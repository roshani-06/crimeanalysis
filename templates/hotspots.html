<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Hotspots</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
            CrimeAnalytics
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/analysis">Analysis</a>
                <a class="nav-link" href="/prediction">Prediction</a>
                <a class="nav-link active" href="/hotspots">Hotspots</a>
                <a class="nav-link" href="/policies">Policies</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Crime Hotspots Mapping</h2>
        <p class="text-muted">Interactive map showing crime hotspots across India</p>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="hotspotForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">State/UT</label>
                            <select class="form-select" name="state" id="stateSelect">
                                <option value="All">All States</option>
                                {% for state in states %}
                                <option value="{{ state }}">{{ state }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Crime Type</label>
                            <select class="form-select" name="crime_type" id="crimeTypeSelect">
                                <option value="Total_Crimes">Total Crimes</option>
                                {% for crime in crime_types %}
                                <option value="{{ crime }}">{{ crime }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary mt-3">Update Map</button>
                </form>
            </div>
        </div>

        <!-- Map Container -->
        <div class="card">
            <div class="card-header">
                <h5>Crime Hotspots Map</h5>
            </div>
            <div class="card-body">
                <div id="map" class="map-container"></div>
            </div>
        </div>

        <!-- Hotspot Statistics -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Top Crime Hotspots</h5>
                    </div>
                    <div class="card-body">
                        <div id="hotspotList"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Hotspot Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="hotspotAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    let map;
    let markers = [];

    document.addEventListener('DOMContentLoaded', function() {
        map = L.map('map').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        loadHotspots();

        document.getElementById('hotspotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            loadHotspots();
        });
    });

    function loadHotspots() {
        const formData = new FormData(document.getElementById('hotspotForm'));
        const params = new URLSearchParams(formData);

        fetch('/api/hotspots/coordinates?' + params)
            .then(response => response.json())
            .then(rawData => {
                // Filter out NON-DISTRICT ENTRIES (Total, All, Overall)
                const filtered = {};

                Object.entries(rawData).forEach(([key, d]) => {
                    if (
                        d.district &&
                        !["total", "all", "overall"].includes(d.district.toLowerCase()) &&
                        d.state &&
                        !["total", "all", "overall"].includes(d.state.toLowerCase())
                    ) {
                        filtered[key] = d;
                    }
                });

                updateHotspotMap(filtered);
                updateHotspotList(filtered);
                updateHotspotAnalysis(filtered);
            })
            .catch(error => console.error('Error loading hotspots:', error));
    }

    function updateHotspotMap(hotspotData) {
        clearMarkers();

        Object.values(hotspotData).forEach(data => {
            const lat = data.latitude;
            const lon = data.longitude;

            if (!lat || !lon) return;

            const marker = L.circleMarker([lat, lon], {
                radius: getRadius(data.crime_count),
                fillColor: getColor(data.crime_count),
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7
            }).addTo(map);

            marker.bindPopup(`
                <div>
                    <h6>${data.district}, ${data.state}</h6>
                    <p><strong>Crime Count:</strong> ${data.crime_count}</p>
                </div>
            `);

            markers.push(marker);
        });

        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    function clearMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
    }

    function updateHotspotList(hotspotData) {
        const hotspotList = document.getElementById('hotspotList');

        const hotspotsArray = Object.values(hotspotData);

        const topHotspots = hotspotsArray
            .sort((a, b) => b.crime_count - a.crime_count)
            .slice(0, 10);

        let html = '<div class="list-group">';

        topHotspots.forEach((h, i) => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-primary me-2">${i + 1}</span>
                        ${h.district}, ${h.state}
                    </div>
                    <span class="badge bg-danger rounded-pill">${h.crime_count}</span>
                </div>
            `;
        });

        html += '</div>';
        hotspotList.innerHTML = html;
    }

    function updateHotspotAnalysis(hotspotData) {
        const analysisDiv = document.getElementById('hotspotAnalysis');
        
        const hotspots = Object.values(hotspotData);
        if (hotspots.length === 0) {
            analysisDiv.innerHTML = "<p class='text-muted'>No hotspot data available.</p>";
            return;
        }

        const counts = hotspots.map(h => h.crime_count);

        const total = counts.reduce((a, b) => a + b, 0);
        const avg = Math.round(total / counts.length);
        const max = Math.max(...counts);

        const highRisk = counts.filter(c => c > 5000).length;
        const mediumRisk = counts.filter(c => c > 1000 && c <= 5000).length;
        const lowRisk = counts.filter(c => c <= 1000).length;

        analysisDiv.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number text-primary">${hotspots.length}</div>
                    <div class="stat-label">Hotspots Identified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-success">${avg}</div>
                    <div class="stat-label">Average Crimes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-danger">${max}</div>
                    <div class="stat-label">Maximum Crimes</div>
                </div>
            </div>

            <div class="mt-3">
                <h6>Risk Distribution:</h6>
                <p><strong>High:</strong> ${highRisk}</p>
                <p><strong>Medium:</strong> ${mediumRisk}</p>
                <p><strong>Low:</strong> ${lowRisk}</p>
            </div>
        `;
    }

    function getRadius(c) {
        if (c > 10000) return 25;
        if (c > 5000) return 20;
        if (c > 2000) return 16;
        if (c > 1000) return 12;
        if (c > 500) return 10;
        if (c > 100) return 8;
        if (c > 50) return 6;
        return 4;
    }

    function getColor(c) {
        if (c > 10000) return '#8B0000';
        if (c > 5000) return '#FF0000';
        if (c > 2000) return '#FF4500';
        if (c > 1000) return '#FF8C00';
        if (c > 500) return '#FFA500';
        if (c > 100) return '#FFD700';
        if (c > 50) return '#FFFF00';
        return '#90EE90';
    }
</script>

</body>
</html>
