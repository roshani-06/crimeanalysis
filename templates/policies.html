<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Insights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .severity-high { border-left: 4px solid #dc3545; }
        .severity-medium { border-left: 4px solid #ffc107; }
        .severity-low { border-left: 4px solid #28a745; }
        .recommendation-card { transition: transform 0.2s; }
        .recommendation-card:hover { transform: translateY(-2px); }
        .trend-badge { font-size: 0.8rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
            CrimeAnalytics
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/analysis">Analysis</a>
                <a class="nav-link" href="/prediction">Prediction</a>
                <a class="nav-link" href="/hotspots">Hotspots</a>
                <a class="nav-link active" href="/policies">Policies</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
    <h2>Crime Prevention Policies & Recommendations</h2>
    <p class="text-muted">Get customized policy suggestions based on crime data analysis</p>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="policyForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">State/UT</label>
                        <select class="form-select" name="state" id="stateSelect">
                            <option value="All">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}">{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">District</label>
                        <select class="form-select" name="district" id="districtSelect">
                            <option value="All">All Districts</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Crime Type</label>
                        <select class="form-select" name="crime_type" id="crimeTypeSelect">
                            <option value="Total_Crimes">Total Crimes</option>
                            {% for crime in crime_types %}
                            <option value="{{ crime }}">{{ crime }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Year</label>
                        <select class="form-select" name="year" id="yearSelect">
                            <option value="2014">2014</option>
                            <option value="All">All Years</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Get Policy Recommendations</button>
            </form>
        </div>
    </div>

    <!-- Policy Results -->
    <div id="policyResults">
        <!-- Results will be loaded here -->
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
       document.addEventListener('DOMContentLoaded', function() {
    // Load initial policies
    loadPolicies();
    
    // Form submission
    document.getElementById('policyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadPolicies();
    });
    
    // State change - load districts
    document.getElementById('stateSelect').addEventListener('change', function() {
        const state = this.value;
        loadDistricts(state);
    });
});

function loadDistricts(state) {
    if (state === 'All') {
        document.getElementById('districtSelect').innerHTML = '<option value="All">All Districts</option>';
        return;
    }
    
    fetch(`/get_districts?state=${encodeURIComponent(state)}`)
        .then(response => response.json())
        .then(districts => {
            const districtSelect = document.getElementById('districtSelect');
            districtSelect.innerHTML = '<option value="All">All Districts</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        });
}

function loadPolicies() {
    const formData = new FormData(document.getElementById('policyForm'));
    const params = new URLSearchParams(formData);
    
    fetch('/api/policies?' + params)
        .then(response => response.json())
        .then(data => {
            displayPolicyResults(data);
        })
        .catch(error => {
            console.error('Error loading policies:', error);
        });
}

function displayPolicyResults(insights) {
    const resultsDiv = document.getElementById('policyResults');
    
    let html = `
        <div class="card">
            <div class="card-header">
                <h5>Policy Recommendations</h5>
                <small class="text-muted">
                    ${insights.area_info.state !== 'All' ? 'State: ' + insights.area_info.state : 'All States'}
                    ${insights.area_info.district !== 'All' ? ' | District: ' + insights.area_info.district : ''}
                    ${insights.area_info.crime_type !== 'Total_Crimes' ? ' | Crime: ' + insights.area_info.crime_type : ''}
                </small>
            </div>
            <div class="card-body">
    `;
    
    // Crime analysis
    if (insights.crime_analysis && insights.crime_analysis.total > 0) {
        html += `
            <div class="alert alert-info">
                <h6>Crime Analysis:</h6>
                <p>Total Crimes: <strong>${insights.crime_analysis.total.toLocaleString()}</strong> | 
                   Average: <strong>${insights.crime_analysis.average.toFixed(1)}</strong> | 
                   Trend: <span class="badge ${insights.crime_analysis.trend === 'increasing' ? 'bg-danger' : 'bg-success'}">${insights.crime_analysis.trend}</span>
                </p>
            </div>
        `;
    }
    
    // Top crimes
    if (Object.keys(insights.top_crimes).length > 0) {
        html += `
            <div class="mb-4">
                <h6>Top Crime Types in Area:</h6>
                <div class="d-flex flex-wrap gap-2">
        `;
        Object.entries(insights.top_crimes).forEach(([crime, count]) => {
            html += `<span class="badge bg-warning">${crime}: ${count.toLocaleString()}</span>`;
        });
        html += `</div></div>`;
    }
    
    // Recommendations
    html += `<h6>Recommended Policies:</h6><ul class="list-group">`;
    insights.recommendations.forEach((recommendation, index) => {
        html += `
            <li class="list-group-item">
                <i class="fas fa-check-circle text-success me-2"></i>
                ${recommendation}
            </li>
        `;
    });
    html += `</ul>`;
    
    html += `</div></div>`;
    resultsDiv.innerHTML = html;
}
    </script>
</body>
</html>